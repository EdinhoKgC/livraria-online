{% extends 'base.html' %}

{% block title %}Finalizar Compra - Livraria Online{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Finalizar Compra</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Resumo do Pedido</h5>
                </div>
                <div class="card-body">
                    {% for item in carrinho.itens.all %}
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-2">
                                {% if item.livro.capa %}
                                    <img src="{{ item.livro.capa }}" alt="Capa do {{ item.livro.titulo }}" 
                                         class="img-fluid rounded" style="height: 80px; object-fit: cover;">
                                {% else %}
                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                         style="height: 80px; width: 60px;">
                                        <small class="text-muted">Sem imagem</small>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">{{ item.livro.titulo }}</h6>
                                <small class="text-muted">Autor: {{ item.livro.autor.nome }}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-primary">Qtd: {{ item.quantidade }}</span>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Categoria: {{ item.livro.categoria.nome }}</small>
                            </div>
                        </div>
                        {% if not forloop.last %}
                            <hr>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">Nenhum item no carrinho.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Endereço de Entrega</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% if enderecos %}
                            <div class="mb-3">
                                <label class="form-label"><strong>Escolher endereço:</strong></label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="novo_endereco" 
                                           value="false" id="endereco_existente" 
                                           {% if not novo_endereco %}checked{% endif %}>
                                    <label class="form-check-label" for="endereco_existente">
                                        Usar endereço existente
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="novo_endereco" 
                                           value="true" id="novo_endereco" 
                                           {% if novo_endereco %}checked{% endif %}>
                                    <label class="form-check-label" for="novo_endereco">
                                        Cadastrar novo endereço
                                    </label>
                                </div>
                            </div>
                            
                            <div id="enderecos_existentes" class="mb-3" {% if novo_endereco %}style="display: none;"{% endif %}>
                                {% for endereco in enderecos %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="endereco_id" 
                                               value="{{ endereco.id }}" id="endereco_{{ endereco.id }}"
                                               {% if forloop.first and not novo_endereco %}checked{% endif %}>
                                        <label class="form-check-label" for="endereco_{{ endereco.id }}">
                                            <strong>{{ endereco.nome_endereco }}</strong><br>
                                            <small>{{ endereco.endereco_completo }}</small>
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div id="form_novo_endereco" {% if not novo_endereco and enderecos %}style="display: none;"{% endif %}>
                            <div class="mb-3">
                                <label for="{{ form.nome_endereco.id_for_label }}" class="form-label">
                                    <strong>Nome do Endereço *</strong>
                                </label>
                                {{ form.nome_endereco }}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="{{ form.cep.id_for_label }}" class="form-label">
                                        <strong>CEP *</strong>
                                    </label>
                                    {{ form.cep }}
                                </div>
                                <div class="col-md-8">
                                    <label for="{{ form.rua.id_for_label }}" class="form-label">
                                        <strong>Rua *</strong>
                                    </label>
                                    {{ form.rua }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="{{ form.numero.id_for_label }}" class="form-label">
                                        <strong>Número *</strong>
                                    </label>
                                    {{ form.numero }}
                                </div>
                                <div class="col-md-9">
                                    <label for="{{ form.complemento.id_for_label }}" class="form-label">
                                        Complemento
                                    </label>
                                    {{ form.complemento }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="{{ form.bairro.id_for_label }}" class="form-label">
                                        <strong>Bairro *</strong>
                                    </label>
                                    {{ form.bairro }}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.cidade.id_for_label }}" class="form-label">
                                        <strong>Cidade *</strong>
                                    </label>
                                    {{ form.cidade }}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form.estado.id_for_label }}" class="form-label">
                                        <strong>Estado *</strong>
                                    </label>
                                    {{ form.estado }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> Confirmar Pedido
                            </button>
                            <a href="{% url 'carrinho:visualizar_carrinho' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar ao Carrinho
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const enderecoExistente = document.getElementById('endereco_existente');
    const novoEndereco = document.getElementById('novo_endereco');
    const enderecosExistentes = document.getElementById('enderecos_existentes');
    const formNovoEndereco = document.getElementById('form_novo_endereco');
    
    if (enderecoExistente && novoEndereco) {
        function toggleEndereco() {
            if (enderecoExistente.checked) {
                enderecosExistentes.style.display = 'block';
                formNovoEndereco.style.display = 'none';
            } else {
                enderecosExistentes.style.display = 'none';
                formNovoEndereco.style.display = 'block';
            }
        }
        
        enderecoExistente.addEventListener('change', toggleEndereco);
        novoEndereco.addEventListener('change', toggleEndereco);
    }
});
</script>
{% endblock %}